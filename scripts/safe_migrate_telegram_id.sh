#!/bin/bash
###############################################################################
# –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø telegram_id: INTEGER ‚Üí BIGINT
#
# –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
# 1. –°–æ–∑–¥–∞–µ—Ç –ü–û–õ–ù–´–ô –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
# 3. –í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é
# 4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# 5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç—á–µ—Ç
#
# –í–ê–ñ–ù–û: –°–∫—Ä–∏–ø—Ç –ù–ï —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ, —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—è–µ—Ç —Ç–∏–ø —Å—Ç–æ–ª–±—Ü–∞!
###############################################################################

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BACKUP_DIR="/root/language_escape_bot/backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/db_backup_before_telegram_id_migration_$TIMESTAMP.sql"
REPORT_FILE="/root/language_escape_bot/logs/migration_telegram_id_$TIMESTAMP.log"

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë   –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø TELEGRAM_ID: INTEGER ‚Üí BIGINT            ‚ïë${NC}"
echo -e "${BLUE}‚ïë   –î–∞—Ç–∞: $(date)                              ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "$1" | tee -a "$REPORT_FILE"
}

# –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$BACKUP_DIR"
mkdir -p "$(dirname "$REPORT_FILE")"

log "\n${YELLOW}üìã –®–∞–≥ 1/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î${NC}"
log "----------------------------------------"

# –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ .env
cd /root/language_escape_bot
source venv/bin/activate

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–∏–ø
CURRENT_TYPE=$(sudo -u postgres psql -d language_escape -t -c "
    SELECT data_type
    FROM information_schema.columns
    WHERE table_name = 'users' AND column_name = 'telegram_id';
" | xargs)

log "–¢–µ–∫—É—â–∏–π —Ç–∏–ø telegram_id: ${BLUE}$CURRENT_TYPE${NC}"

# –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
USER_COUNT=$(sudo -u postgres psql -d language_escape -t -c "SELECT COUNT(*) FROM users;" | xargs)
log "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î: ${GREEN}$USER_COUNT${NC}"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –±–æ–ª—å—à–∏—Ö ID
LARGE_IDS=$(sudo -u postgres psql -d language_escape -t -c "
    SELECT COUNT(*) FROM users WHERE telegram_id > 2147483647;
" | xargs || echo "0")
log "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–æ–ª—å—à–∏–º–∏ ID (>2147483647): ${YELLOW}$LARGE_IDS${NC}"

# –ï—Å–ª–∏ —Ç–∏–ø —É–∂–µ BIGINT, –≤—ã—Ö–æ–¥–∏–º
if [ "$CURRENT_TYPE" = "bigint" ]; then
    log "\n${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø!${NC}"
    log "telegram_id —É–∂–µ –∏–º–µ–µ—Ç —Ç–∏–ø BIGINT"
    exit 0
fi

log "\n${YELLOW}üì¶ –®–∞–≥ 2/5: –°–æ–∑–¥–∞–Ω–∏–µ –ü–û–õ–ù–û–ì–û –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö${NC}"
log "----------------------------------------"
log "–§–∞–π–ª –±—ç–∫–∞–ø–∞: $BACKUP_FILE"

# –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
sudo -u postgres pg_dump language_escape > "$BACKUP_FILE"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞
BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
log "${GREEN}‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! –†–∞–∑–º–µ—Ä: $BACKUP_SIZE${NC}"

# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –±—ç–∫–∞–ø –Ω–µ –ø—É—Å—Ç–æ–π
if [ ! -s "$BACKUP_FILE" ]; then
    log "${RED}‚ùå –û–®–ò–ë–ö–ê: –ë—ç–∫–∞–ø –ø—É—Å—Ç–æ–π! –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.${NC}"
    exit 1
fi

log "\n${YELLOW}üîç –®–∞–≥ 3/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏${NC}"
log "----------------------------------------"
log "ALTER COLUMN –æ—Ç INTEGER –∫ BIGINT - –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –æ–ø–µ—Ä–∞—Ü–∏—è:"
log "  ‚úì –ù–µ —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ"
log "  ‚úì –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è"
log "  ‚úì –¢–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω (–¥–æ 9,223,372,036,854,775,807)"
log "  ‚úì –ó–∞–Ω–∏–º–∞–µ—Ç ~10-30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü"

read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é? (yes/no): " -r
if [[ ! $REPLY =~ ^[Yy]es$ ]]; then
    log "${YELLOW}‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º${NC}"
    exit 0
fi

log "\n${YELLOW}üîÑ –®–∞–≥ 4/5: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏${NC}"
log "----------------------------------------"

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
log "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ALTER TABLE users ALTER COLUMN telegram_id TYPE BIGINT..."

sudo -u postgres psql -d language_escape -c "
    ALTER TABLE users
    ALTER COLUMN telegram_id TYPE BIGINT;
" >> "$REPORT_FILE" 2>&1

log "${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"

log "\n${YELLOW}‚úÖ –®–∞–≥ 5/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞${NC}"
log "----------------------------------------"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø
NEW_TYPE=$(sudo -u postgres psql -d language_escape -t -c "
    SELECT data_type
    FROM information_schema.columns
    WHERE table_name = 'users' AND column_name = 'telegram_id';
" | xargs)

log "–ù–æ–≤—ã–π —Ç–∏–ø telegram_id: ${GREEN}$NEW_TYPE${NC}"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
NEW_USER_COUNT=$(sudo -u postgres psql -d language_escape -t -c "SELECT COUNT(*) FROM users;" | xargs)
log "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏: ${GREEN}$NEW_USER_COUNT${NC}"

# –°—Ä–∞–≤–Ω–∏—Ç—å
if [ "$USER_COUNT" -eq "$NEW_USER_COUNT" ]; then
    log "${GREEN}‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ! ($USER_COUNT = $NEW_USER_COUNT)${NC}"
else
    log "${RED}‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑–º–µ–Ω–∏–ª–æ—Å—å!${NC}"
    log "${RED}   –î–æ: $USER_COUNT, –ü–æ—Å–ª–µ: $NEW_USER_COUNT${NC}"
    log "${YELLOW}   –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞: psql language_escape < $BACKUP_FILE${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π
log "\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π:"
sudo -u postgres psql -d language_escape -c "
    SELECT telegram_id, first_name, created_at
    FROM users
    ORDER BY created_at DESC
    LIMIT 3;
" | tee -a "$REPORT_FILE"

log "\n${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
log "${GREEN}‚ïë   ‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!                               ‚ïë${NC}"
log "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"

log "\nüìä –ò—Ç–æ–≥–∏:"
log "  ‚Ä¢ –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω: $CURRENT_TYPE ‚Üí $NEW_TYPE"
log "  ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏: $USER_COUNT"
log "  ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏: $NEW_USER_COUNT"
log "  ‚Ä¢ –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω: $BACKUP_FILE"
log "  ‚Ä¢ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: $REPORT_FILE"
log "  ‚Ä¢ –ù–æ–≤—ã–π –ª–∏–º–∏—Ç telegram_id: –¥–æ 9,223,372,036,854,775,807"

log "\n${BLUE}üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
log "  1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: systemctl restart language-escape-bot"
log "  2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ID 5273817226"
log "  3. –ë—ç–∫–∞–ø –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –µ—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç"

exit 0
