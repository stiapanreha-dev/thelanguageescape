name: Deploy to VPS

on:
  push:
    branches:
      - main  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ push Ð² main
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· GitHub UI

jobs:
  deploy:
    name: Deploy Bot to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "Host *" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          ssh -p "$VPS_PORT" "$VPS_USER@$VPS_HOST" bash << 'ENDSSH'
            set -e

            echo "ðŸš€ Starting deployment..."

            # Navigate to project directory
            cd /root/language_escape_bot

            # Pull latest changes
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main

            # Activate virtual environment
            echo "ðŸ Activating virtual environment..."
            source venv/bin/activate

            # Install/update dependencies
            echo "ðŸ“¦ Installing dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt

            # Restart bot service
            echo "ðŸ”„ Restarting bot service..."
            sudo systemctl restart language-escape-bot

            # Check status
            echo "âœ… Checking service status..."
            sudo systemctl status language-escape-bot --no-pager || true

            echo "ðŸŽ‰ Deployment complete!"
          ENDSSH

      - name: Verify deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          sleep 5
          ssh -p "$VPS_PORT" "$VPS_USER@$VPS_HOST" bash << 'ENDSSH'
            # Check if service is running
            if systemctl is-active --quiet language-escape-bot; then
              echo "âœ… Bot is running successfully"
              exit 0
            else
              echo "âŒ Bot failed to start"
              sudo journalctl -u language-escape-bot -n 50 --no-pager
              exit 1
            fi
          ENDSSH

      - name: Send notification on success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          # ÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Telegram

      - name: Send notification on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          # ÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Telegram
